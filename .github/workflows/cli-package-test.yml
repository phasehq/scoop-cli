name: Scoop Manifest Validation

on:
  push:
    paths:
      - "phase.json"
  pull_request:
    paths:
      - "phase.json"

jobs:
  manifest-validation:
    name: Validate Scoop Manifest
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install Scoop Package Manager
        run: iex "& {$(irm get.scoop.sh)} -RunAsAdmin"
        shell: pwsh

      - name: Install Scoop and Configure
        run: |
          iex "& {$(irm get.scoop.sh)} -RunAsAdmin"
          $env:Path += ";$env:USERPROFILE\scoop\shims"
          scoop bucket add my-bucket ${{ github.workspace }}
        shell: pwsh

      - name: Install Software from Manifest
        run: |
          scoop install phase.json

      - name: Determine Manifest Version
        id: manifest-version
        run: |
          $content = Get-Content phase.json | ConvertFrom-Json
          echo "::set-output name=version::${content.version}"

      - name: Verify CLI Version
        run: |
          $expected = "${{ steps.manifest-version.outputs.version }}"
          $actual = & phase --version
          if ($actual -ne $expected) {
            throw "Mismatch: Expected $expected, but found $actual"
          }
        shell: pwsh
